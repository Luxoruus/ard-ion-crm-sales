[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Opportunity",
  "enabled": 1,
  "modified": "2025-11-08 22:03:35.165810",
  "module": "Ion Crm Sales",
  "name": "Opportunity Workflow",
  "script": "frappe.ui.form.on('Opportunity', {\n    \n    custom_warehouse: function(frm) {\n        frm.doc.items.forEach(function(item) {\n            // Check if the item_code is set in the current row\n            if (item.item_code) {\n                // Call a server-side method to fetch the valuation rate\n                frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"Bin\",\n                        filters: {\n                            \"item_code\": item.item_code,\n                            \"warehouse\": frm.doc.custom_warehouse\n                        },\n                        fieldname: [\"valuation_rate\", \"actual_qty\"]\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.valuation_rate) {\n                            // Set the valuation rate in the current row\n                            frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                        } else {\n                            frappe.model.set_value(item.doctype, item.name, \"custom_availability\", \"Unavailable\")\n                            frappe.show_alert(\"Valuation rate not found for \" + item.item_code, \"orange\");\n                        }\n                    }\n                });\n            }\n        });  \n    },\n    \n    opportunity_from: function(frm){\n        switch (frm.doc.opportunity_from){\n            case \"Customer\":\n                frm.doc.sales_stage = 'Opportunity';\n                break;\n            case \"Prospect\":\n                frm.doc.sales_stage = 'Prospecting';\n                break;\n        }\n    },\n    \n    refresh: function(frm) {\n        if (frm.doc.custom_surveyor_manager == frappe.session.user){\n            frm.set_df_property('custom_surveyor', 'hidden', 0);\n        } else {\n            frm.set_df_property('custom_surveyor', 'hidden', 1);\n        }\n        \n        \n        if (['Requirements Gathering', 'Surveying', 'Approved'].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\".actions-btn-group\").hide()\n        } else {\n            frm.$wrapper.find(\".actions-btn-group\").show()\n        }\n        \n        if (frm.doc.opportunity_type === 'Sales') {\n            frm.set_value('opportunity_type', 'Dedicated');\n        }\n        \n        if (!frm.doc.custom_request){\n            frm.set_df_property('custom_requirements', 'read_only', 1)\n        }\n        \n        if ([\"Requirements Gathering\"].includes(frm.doc.workflow_state)) {\n            frm.$wrapper.find(\"[data-fieldname='custom_scope']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_scope']\").show();\n        }\n        \n        \n        if ([\"Requirements Gathering\", \"Scoping\"].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").show();\n        }\n        \n        console.log(([\"Requirements Gathering\", \"Scoping\", \"Qualifying\"].includes(frm.doc.workflow_state) || frm.doc.workflow_state == \"Rejected\").toString())\n        \n        if ([\"Requirements Gathering\", \"Scoping\", \"Qualifying\"].includes(frm.doc.workflow_state) || frm.doc.workflow_state == \"Rejected\") {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").show();\n        }\n        \n        if ([\"Requirements Gathering\", \"Scoping\", \"Qualifying\", \"Surveying\"].includes(frm.doc.workflow_state) || frm.doc.workflow_state == \"Rejected\") {\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").show();\n        }\n        \n        \n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').hide()\n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').hide()\n        \n        if (!['Requirements Gathering', 'Scoping', 'Qualifying', 'Rejected'].includes(frm.doc.workflow_state) && frm.doc.opportunity_from == 'Prospect'){\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item[data-label=\"Customer\"]').show()\n        }\n        \n        if (frm.doc.workflow_state == \"Approved\"){\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').show()\n        }\n\n    },\n    validate: function(frm){\n        if (frm.doc.custom_request){\n            frm.set_df_property('custom_requirements', 'read_only', 0)\n        }\n        \n        \n        if (frm.doc.custom_requirements && frm.doc.workflow_state !== \"Scoping\" && frm.doc.workflow_state == \"Requirements Gathering\") {\n            frm.set_value('workflow_state', 'Scoping');\n            frm.refresh()\n        }\n        \n        /*if (frm.doc.custom_surveys.length > 0 && frm.doc.workflow_state == \"Surveying\") {\n            frm.set_value('workflow_state', 'Technical Qualification');\n            frm.refresh()\n        }*/\n    }\n});\n\n\nfrappe.ui.form.on('Opportunity Item', {\n    calculate: function(frm, cdt, cdn){\n        var item = frappe.get_doc(cdt, cdn);\n        var item_code = item.item_code;\n        if (item_code && frm.doc.custom_warehouse) {\n            frappe.call({\n                method: \"frappe.client.get_value\",\n                args: {\n                    doctype: \"Bin\",\n                    filters: {\n                        \"item_code\": item_code,\n                        \"warehouse\": frm.doc.custom_warehouse\n                    },\n                    fieldname: [\"valuation_rate\", \"actual_qty\"]\n                },\n                callback: function(r) {\n                    if (r.message && r.message.valuation_rate) {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                    } else {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", \"Unavailable\")\n                        console.log(\"Valuation rate not found for item: \" + item_code + \" in warehouse: \" + frm.doc.custom_warehouse);\n                    }\n                }\n            });\n        }\n    },\n    item_code: function(frm, cdt, cdn) {\n        var item = frappe.get_doc(cdt, cdn);\n        var price_list = frm.doc.custom_price_list; // Get the selected price list from the Opportunity DocType\n        var item_code = item.item_code;\n\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Item Price',\n                filters: {\n                    item_code: item_code,\n                    price_list: price_list\n                },\n                fieldname: 'price_list_rate'\n            },\n            callback: function(response) {\n                if (response && response.message) {\n                    frappe.model.set_value(cdt, cdn, 'rate', response.message.price_list_rate);\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Opportunity Hotels",
  "enabled": 1,
  "modified": "2025-11-08 22:55:36.266488",
  "module": "Ion Crm Sales",
  "name": "Opportunity Hotels Workflow",
  "script": "frappe.ui.form.on('Opportunity Hotels', {\n    \n    custom_warehouse: function(frm) {\n        frm.doc.items.forEach(function(item) {\n            // Check if the item_code is set in the current row\n            if (item.item_code) {\n                // Call a server-side method to fetch the valuation rate\n                frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"Bin\",\n                        filters: {\n                            \"item_code\": item.item_code,\n                            \"warehouse\": frm.doc.custom_warehouse\n                        },\n                        fieldname: [\"valuation_rate\", \"actual_qty\"]\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.valuation_rate) {\n                            // Set the valuation rate in the current row\n                            frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                        } else {\n                            frappe.model.set_value(item.doctype, item.name, \"custom_availability\", \"Unavailable\")\n                            frappe.show_alert(\"Valuation rate not found for \" + item.item_code, \"orange\");\n                        }\n                    }\n                });\n            }\n        });  \n    },\n    \n    opportunity_from: function(frm){\n        switch (frm.doc.opportunity_from){\n            case \"Customer\":\n                frm.doc.sales_stage = 'Opportunity';\n                frm.refresh_field('sales_stage')\n                break;\n            case \"Prospect\":\n                frm.doc.sales_stage = 'Prospecting';\n                frm.refresh_field('sales_stage')\n                break;\n        }\n    },\n    \n    refresh: function(frm) {\n        if (['Requirements Gathering', 'Scoping', 'Surveying', 'Approved'].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\".actions-btn-group\").hide()\n        } else {\n            frm.$wrapper.find(\".actions-btn-group\").show()\n        }\n        \n        if (frm.doc.opportunity_type === 'Sales') {\n            frm.set_value('opportunity_type', 'Dedicated');\n        }\n        \n        if (!frm.doc.custom_request){\n            frm.set_df_property('custom_requirements', 'read_only', 1)\n        }\n        \n        if ([\"Requirements Gathering\"].includes(frm.doc.workflow_state)) {\n            frm.$wrapper.find(\"[data-fieldname='custom_scope']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_scope']\").show();\n        }\n        \n        \n        if ([\"Requirements Gathering\", \"Scoping\"].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").show();\n        }\n        \n        if ([\"Requirements Gathering\", \"Scoping\", \"Qualifying\"].includes(frm.doc.workflow_state) || frm.doc.workflow_state == \"Rejected\") {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").show();\n        }\n        \n        \n        if (frm.doc.custom_surveys.length == 0){\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").hide()\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").show()\n        }\n        \n        \n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').hide()\n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').hide()\n        \n        if (!['Requirements Gathering', 'Scoping', 'Qualifying', 'Rejected'].includes(frm.doc.workflow_state) && frm.doc.opportunity_from == 'Prospect'){\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item[data-label=\"Customer\"]').show()\n        }\n        \n        if (frm.doc.workflow_state == \"Approved\"){\n            setTimeout(() => {\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').show()\n                \n            }, 300)\n        }\n        \n        if (frm.doc.workflow_state == \"Surveyed\"){\n            frm.$wrapper.find(\".actions-btn-group\").show()\n            setTimeout(() => {\n                frm.$wrapper.find(\".actions-btn-group .dropdown-item\").show()\n                frm.$wrapper.find(\".actions-btn-group .dropdown-item:has(.menu-item-label[data-label='Approve'])\").hide()\n                \n            }, 300)\n            \n            \n            if (frm.doc.items.length > 0){\n                setTimeout(() => {\n                    frm.$wrapper.find('.actions-btn-group .dropdown-item:has(.menu-item-label[data-label=\"Approve\"])').show()\n                }, 300)\n            }\n        }\n\n    },\n    validate: function(frm){\n        if (frm.doc.custom_request){\n            frm.set_df_property('custom_requirements', 'read_only', 0)\n        }\n        \n        \n        if (frm.doc.custom_requirements && frm.doc.workflow_state !== \"Scoping\" && frm.doc.workflow_state == \"Requirements Gathering\") {\n            frm.set_value('workflow_state', 'Scoping');\n            frm.refresh()\n        }\n        \n        if (frm.doc.custom_scope_description && frm.doc.custom_deliverables && frm.doc.workflow_state == \"Scoping\"){\n            frm.set_value('workflow_state', 'Qualifying')\n            frm.refresh()\n        }\n    }\n});\n\n\n\nfrappe.ui.form.on('Opportunity Item', {\n    calculate: function(frm, cdt, cdn){\n        var item = frappe.get_doc(cdt, cdn);\n        var item_code = item.item_code;\n        if (item_code && frm.doc.custom_warehouse) {\n            frappe.call({\n                method: \"frappe.client.get_value\",\n                args: {\n                    doctype: \"Bin\",\n                    filters: {\n                        \"item_code\": item_code,\n                        \"warehouse\": frm.doc.custom_warehouse\n                    },\n                    fieldname: [\"valuation_rate\", \"actual_qty\"]\n                },\n                callback: function(r) {\n                    if (r.message && r.message.valuation_rate) {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                    } else {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", \"Unavailable\")\n                        console.log(\"Valuation rate not found for item: \" + item_code + \" in warehouse: \" + frm.doc.custom_warehouse);\n                    }\n                }\n            });\n        }\n    },\n    \n    item_code: function(frm, cdt, cdn) {\n        var item = frappe.get_doc(cdt, cdn);\n        var price_list = frm.doc.custom_price_list; // Get the selected price list from the Opportunity DocType\n        var item_code = item.item_code;\n\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Item Price',\n                filters: {\n                    item_code: item_code,\n                    price_list: price_list\n                },\n                fieldname: 'price_list_rate'\n            },\n            callback: function(response) {\n                if (response && response.message) {\n                    frappe.model.set_value(cdt, cdn, 'rate', response.message.price_list_rate);\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Opportunity SM",
  "enabled": 1,
  "modified": "2025-10-04 10:40:07.572874",
  "module": "Ion Crm Sales",
  "name": "Opportunity SM Workflow",
  "script": "frappe.ui.form.on('Opportunity SM', {\n    \n    custom_warehouse: function(frm) {\n        frm.doc.items.forEach(function(item) {\n            // Check if the item_code is set in the current row\n            if (item.item_code) {\n                // Call a server-side method to fetch the valuation rate\n                frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"Bin\",\n                        filters: {\n                            \"item_code\": item.item_code,\n                            \"warehouse\": frm.doc.custom_warehouse\n                        },\n                        fieldname: [\"valuation_rate\", \"actual_qty\"]\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.valuation_rate) {\n                            // Set the valuation rate in the current row\n                            frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                        } else {\n                            frappe.model.set_value(item.doctype, item.name, \"custom_availability\", \"Unavailable\")\n                            frappe.show_alert(\"Valuation rate not found for \" + item.item_code, \"orange\");\n                        }\n                    }\n                });\n            }\n        });  \n    },\n    \n    opportunity_from: function(frm){\n        switch (frm.doc.opportunity_from){\n            case \"Customer\":\n                frm.doc.sales_stage = 'Opportunity';\n                frm.refresh_field('sales_stage')\n                break;\n            case \"Prospect\":\n                frm.doc.sales_stage = 'Prospecting';\n                frm.refresh_field('sales_stage')\n                break;\n        }\n    },\n    \n    refresh: function(frm) {\n        if (['Requirements Gathering', 'Scoping', 'Surveying', 'Approved'].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\".actions-btn-group\").hide()\n        } else {\n            frm.$wrapper.find(\".actions-btn-group\").show()\n        }\n        \n        if (frm.doc.opportunity_type === 'Sales') {\n            frm.set_value('opportunity_type', 'Dedicated');\n        }\n        \n        if (!frm.doc.custom_request){\n            frm.set_df_property('custom_requirements', 'read_only', 1)\n        }\n        \n        if ([\"Requirements Gathering\"].includes(frm.doc.workflow_state)) {\n            frm.$wrapper.find(\"[data-fieldname='custom_scope']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_scope']\").show();\n        }\n        \n        \n        if ([\"Requirements Gathering\", \"Scoping\"].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").show();\n        }\n        \n        if ([\"Requirements Gathering\", \"Scoping\", \"Qualifying\"].includes(frm.doc.workflow_state) || frm.doc.workflow_state == \"Rejected\") {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").show();\n        }\n        \n        \n        if (frm.doc.custom_surveys.length == 0){\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").hide()\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").show()\n        }\n        \n        \n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').hide()\n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').hide()\n        \n        if (!['Requirements Gathering', 'Scoping', 'Qualifying', 'Rejected'].includes(frm.doc.workflow_state) && frm.doc.opportunity_from == 'Prospect'){\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item[data-label=\"Customer\"]').show()\n        }\n        \n        if (frm.doc.workflow_state == \"Approved\"){\n            setTimeout(() => {\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').show()\n                \n            }, 300)\n        }\n        \n        if (frm.doc.workflow_state == \"Surveyed\"){\n            frm.$wrapper.find(\".actions-btn-group\").show()\n            setTimeout(() => {\n                frm.$wrapper.find(\".actions-btn-group .dropdown-item\").show()\n                frm.$wrapper.find(\".actions-btn-group .dropdown-item:has(.menu-item-label[data-label='Approve'])\").hide()\n                \n            }, 300)\n            \n            \n            if (frm.doc.items.length > 0){\n                setTimeout(() => {\n                    frm.$wrapper.find('.actions-btn-group .dropdown-item:has(.menu-item-label[data-label=\"Approve\"])').show()\n                }, 300)\n            }\n        }\n\n    },\n    validate: function(frm){\n        if (frm.doc.custom_request){\n            frm.set_df_property('custom_requirements', 'read_only', 0)\n        }\n        \n        \n        if (frm.doc.custom_requirements && frm.doc.workflow_state !== \"Scoping\" && frm.doc.workflow_state == \"Requirements Gathering\") {\n            frm.set_value('workflow_state', 'Scoping');\n            frm.refresh()\n        }\n        \n        if (frm.doc.custom_scope_description && frm.doc.custom_deliverables && frm.doc.workflow_state == \"Scoping\"){\n            frm.set_value('workflow_state', 'Qualifying')\n            frm.refresh()\n        }\n    }\n});\n\n\nfrappe.ui.form.on('Opportunity Item', {\n    calculate: function(frm, cdt, cdn){\n        var item = frappe.get_doc(cdt, cdn);\n        var item_code = item.item_code;\n        if (item_code && frm.doc.custom_warehouse) {\n            frappe.call({\n                method: \"frappe.client.get_value\",\n                args: {\n                    doctype: \"Bin\",\n                    filters: {\n                        \"item_code\": item_code,\n                        \"warehouse\": frm.doc.custom_warehouse\n                    },\n                    fieldname: [\"valuation_rate\", \"actual_qty\"]\n                },\n                callback: function(r) {\n                    if (r.message && r.message.valuation_rate) {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                    } else {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", \"Unavailable\")\n                        console.log(\"Valuation rate not found for item: \" + item_code + \" in warehouse: \" + frm.doc.custom_warehouse);\n                    }\n                }\n            });\n        }\n    },\n    item_code: function(frm, cdt, cdn) {\n        var item = frappe.get_doc(cdt, cdn);\n        var price_list = frm.doc.custom_price_list; // Get the selected price list from the Opportunity DocType\n        var item_code = item.item_code;\n\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Item Price',\n                filters: {\n                    item_code: item_code,\n                    price_list: price_list\n                },\n                fieldname: 'price_list_rate'\n            },\n            callback: function(response) {\n                if (response && response.message) {\n                    frappe.model.set_value(cdt, cdn, 'rate', response.message.price_list_rate);\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Opportunity Tenders",
  "enabled": 1,
  "modified": "2025-10-04 10:40:39.519725",
  "module": "Ion Crm Sales",
  "name": "Opportunity Tenders Workflow",
  "script": "frappe.ui.form.on('Opportunity Tenders', {\n    \n    custom_warehouse: function(frm) {\n        frm.doc.items.forEach(function(item) {\n            // Check if the item_code is set in the current row\n            if (item.item_code) {\n                // Call a server-side method to fetch the valuation rate\n                frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"Bin\",\n                        filters: {\n                            \"item_code\": item.item_code,\n                            \"warehouse\": frm.doc.custom_warehouse\n                        },\n                        fieldname: [\"valuation_rate\", \"actual_qty\"]\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.valuation_rate) {\n                            // Set the valuation rate in the current row\n                            frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                        } else {\n                            frappe.model.set_value(item.doctype, item.name, \"custom_availability\", \"Unavailable\")\n                            frappe.show_alert(\"Valuation rate not found for \" + item.item_code, \"orange\");\n                        }\n                    }\n                });\n            }\n        });  \n    },\n    \n    opportunity_from: function(frm){\n        switch (frm.doc.opportunity_from){\n            case \"Customer\":\n                frm.doc.sales_stage = 'Opportunity';\n                frm.refresh_field('sales_stage')\n                break;\n            case \"Prospect\":\n                frm.doc.sales_stage = 'Prospecting';\n                frm.refresh_field('sales_stage')\n                break;\n        }\n    },\n    \n    refresh: function(frm) {\n        if (['Scoping', 'Surveying', 'Approved'].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\".actions-btn-group\").hide()\n        } else {\n            frm.$wrapper.find(\".actions-btn-group\").show()\n        }\n        \n        if (frm.doc.opportunity_type === 'Sales') {\n            frm.set_value('opportunity_type', 'Dedicated');\n        }\n        \n        \n        if ([\"Scoping\"].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").show();\n        }\n        \n        if ([\"Scoping\"].includes(frm.doc.workflow_state) || frm.doc.workflow_state == \"Rejected\") {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").show();\n        }\n        \n        \n        if (frm.doc.custom_surveys.length == 0){\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").hide()\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").show()\n        }\n        \n        \n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').hide()\n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').hide()\n        \n        if (!['Scoping', 'Qualifying', 'Rejected'].includes(frm.doc.workflow_state) && frm.doc.opportunity_from == 'Prospect'){\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item[data-label=\"Customer\"]').show()\n        }\n        \n        if (frm.doc.workflow_state == \"Approved\"){\n            setTimeout(() => {\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').show()\n                \n            }, 300)\n        }\n        \n        if (frm.doc.workflow_state == \"Surveyed\"){\n            frm.$wrapper.find(\".actions-btn-group\").show()\n            setTimeout(() => {\n                frm.$wrapper.find(\".actions-btn-group .dropdown-item\").show()\n                frm.$wrapper.find(\".actions-btn-group .dropdown-item:has(.menu-item-label[data-label='Approve'])\").hide()\n                \n            }, 300)\n            \n            \n            if (frm.doc.items.length > 0){\n                setTimeout(() => {\n                    frm.$wrapper.find('.actions-btn-group .dropdown-item:has(.menu-item-label[data-label=\"Approve\"])').show()\n                }, 300)\n            }\n        }\n\n    },\n    validate: function(frm){\n        \n        if (frm.doc.custom_scope_description && frm.doc.custom_deliverables.length > 0 && frm.doc.custom_cxo_team.length > 0 && frm.doc.custom_cxo_team_leader && frm.doc.workflow_state == \"Scoping\"){\n            frm.set_value('workflow_state', 'Surveying')\n            frm.refresh()\n        }\n    }\n});\n\n\nfrappe.ui.form.on('Opportunity Item', {\n    calculate: function(frm, cdt, cdn){\n        var item = frappe.get_doc(cdt, cdn);\n        var item_code = item.item_code;\n        if (item_code && frm.doc.custom_warehouse) {\n            frappe.call({\n                method: \"frappe.client.get_value\",\n                args: {\n                    doctype: \"Bin\",\n                    filters: {\n                        \"item_code\": item_code,\n                        \"warehouse\": frm.doc.custom_warehouse\n                    },\n                    fieldname: [\"valuation_rate\", \"actual_qty\"]\n                },\n                callback: function(r) {\n                    if (r.message && r.message.valuation_rate) {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                    } else {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", \"Unavailable\")\n                        console.log(\"Valuation rate not found for item: \" + item_code + \" in warehouse: \" + frm.doc.custom_warehouse);\n                    }\n                }\n            });\n        }\n    },\n    item_code: function(frm, cdt, cdn) {\n        var item = frappe.get_doc(cdt, cdn);\n        var price_list = frm.doc.custom_price_list; // Get the selected price list from the Opportunity DocType\n        var item_code = item.item_code;\n\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Item Price',\n                filters: {\n                    item_code: item_code,\n                    price_list: price_list\n                },\n                fieldname: 'price_list_rate'\n            },\n            callback: function(response) {\n                if (response && response.message) {\n                    frappe.model.set_value(cdt, cdn, 'rate', response.message.price_list_rate);\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Hotspot",
  "enabled": 0,
  "modified": "2025-08-15 17:48:30.672259",
  "module": "Ion Crm Sales",
  "name": "Hotspot Workflow",
  "script": "frappe.ui.form.on('Hotspot', {\n\trefresh(frm) {\n\t    /*if (frm.doc.workflow_state == 'Qualifying' && frm.doc.quote != ''){\n\t        if (frappe.db.exists('Quotation', {'name': frm.doc.quote})){\n\t            frm.doc.workflow_state = 'Quoted'\n\t        } else {\n\t            frm.doc.quote = ''\n\t        }\n\t    }*/\n\t    \n\t    frm.set_df_property('party_name', 'label', String(frm.doc.hotspot_for))\n\t    \n\t    if (['Requirements Gathering', 'Closed'].includes(frm.doc.workflow_state)){\n\t        frm.set_df_property('requirements', 'hidden', false)\n\t    } else {\n\t        frm.set_df_property('requirements', 'hidden', true)\n\t    }\n\t    \n\t    \n\t    if (frm.doc.workflow_state == 'Qualifying'){\n\t        frm.$wrapper.find(\".actions-btn-group\").hide()\n\t    } else {\n\t        frm.$wrapper.find(\".actions-btn-group\").show()\n\t    }\n\t\t\n\t},\n\t\n\thotspot_for(frm){\n\t    if (frm.doc.hotspot_for != \"\")\n\t        frm.set_df_property('party_name', 'label', String(frm.doc.hotspot_for))\n\t},\n\t\n\tvalidate(frm) {\n\t    if(frm.doc.workflow_state == \"Qualifying\" && frm.doc.request != ''){\n\t        switch (frm.doc.type){\n\t            case 'Reach':\n\t                // Do something\n\t                break;\n\t            case 'Received':\n\t                // Do received\n\t                break;\n\t            case 'Custom':\n\t                // Do custom\n\t                break;\n    \t        default:\n    \t            break;\n\t        }\n\t    }\n\t    \n\t    if (frm.doc.workflow_state == 'Qualifying' && frm.doc.request == ''){\n\t        frm.$wrapper.find(\".actions-btn-group\").hide()\n\t    } else {\n\t        frm.$wrapper.find(\".actions-btn-group\").show()\n\t    }\n\t}\n})",
  "view": "Form"
 }
]