[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Opportunity",
  "enabled": 1,
  "modified": "2026-01-31 15:17:11.972177",
  "module": "Ion Crm Sales",
  "name": "Opportunity Workflow",
  "script": "frappe.ui.form.on('Opportunity', {\n    party_name: function(frm){\n        if (frm.doc.opportunity_from == \"Customer\"){\n\n            frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"Customer\",\n                        filters: {\n                            \"name\": frm.doc.party_name\n                        },\n                        fieldname: [\"custom_nationality\"]\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.custom_nationality) {\n                            frappe.model.set_value(\"Opportunity\", frm.doc.name, 'custom_nationality', r.message.custom_nationality);\n                        } \n                    }\n                });\n        }\n    },\n    \n    custom_warehouse: function(frm) {\n        frm.doc.items.forEach(function(item) {\n            // Check if the item_code is set in the current row\n            if (item.item_code) {\n                // Call a server-side method to fetch the valuation rate\n                frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"Bin\",\n                        filters: {\n                            \"item_code\": item.item_code,\n                            \"warehouse\": frm.doc.custom_warehouse\n                        },\n                        fieldname: [\"valuation_rate\", \"actual_qty\"]\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.valuation_rate) {\n                            // Set the valuation rate in the current row\n                            frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                        } else {\n                            frappe.model.set_value(item.doctype, item.name, \"custom_availability\", \"Unavailable\")\n                            frappe.show_alert(\"Valuation rate not found for \" + item.item_code, \"orange\");\n                        }\n                    }\n                });\n            }\n        });  \n    },\n    \n    opportunity_from: function(frm){\n        switch (frm.doc.opportunity_from){\n            case \"Customer\":\n                frm.doc.sales_stage = 'Opportunity';\n                break;\n            case \"Prospect\":\n                frm.doc.sales_stage = 'Prospecting';\n                break;\n        }\n    },\n    \n    refresh: function(frm) {\n        if (!frm.is_new() && frm.doc.status !== \"Lost\") {\n\t\t\tif (frm.doc.opportunity_from == \"Customer\"){\n\t\t\t\tfrm.add_custom_button(\n\t\t\t\t\t__(\"Issue\"),\n\t\t\t\t\tfunction () {\n\t\t\t\t\t\tfrm.trigger(\"create_issue\");\n\t\t\t\t\t},\n\t\t\t\t\t__(\"Create\")\n\t\t\t\t)\n\t\t\t}\n        }\n        \n        frm.set_df_property('custom_survey_details', 'cannot_add_rows', 1)\n        \n        let departments = frm.doc.custom_surveyors.filter(x => x.surveyor == frappe.session.user).map(x => x.department)\n        \n        frm.fields_dict.custom_survey_details.grid.grid_rows.forEach(row => {\n                    console.log(row.doc)\n                if (!departments.includes(row.doc.department)) {\n                    $(row.row).hide();\n                }\n        });\n        \n        \n        /*if (frm.doc.custom_surveyor_manager == frappe.session.user){\n            frm.set_df_property('custom_surveyor', 'hidden', 0);\n        } else {\n            frm.set_df_property('custom_surveyor', 'hidden', 1);\n        }*/\n        \n        \n        \n        \n        if (['Requirements Gathering', 'Surveying', 'Approved'].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\".actions-btn-group\").hide()\n        } else {\n            frm.$wrapper.find(\".actions-btn-group\").show()\n        }\n        \n        if (frm.doc.opportunity_type === 'Sales') {\n            frm.set_value('opportunity_type', 'Dedicated');\n        }\n        \n        if (!frm.doc.custom_request){\n            frm.set_df_property('custom_requirements', 'read_only', 1)\n        }\n        \n        if ([\"Requirements Gathering\"].includes(frm.doc.workflow_state)) {\n            frm.$wrapper.find(\"[data-fieldname='custom_scope']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_scope']\").show();\n        }\n        \n        \n        if ([\"Requirements Gathering\", \"Scoping\"].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").show();\n        }\n        \n        console.log(([\"Requirements Gathering\", \"Scoping\", \"Qualifying\"].includes(frm.doc.workflow_state) || frm.doc.workflow_state == \"Rejected\").toString())\n        \n        if ([\"Requirements Gathering\", \"Scoping\", \"Qualifying\"].includes(frm.doc.workflow_state) || frm.doc.workflow_state == \"Rejected\") {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").show();\n        }\n        \n        if ([\"Requirements Gathering\", \"Scoping\", \"Qualifying\", \"Surveying\"].includes(frm.doc.workflow_state) || frm.doc.workflow_state == \"Rejected\") {\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").show();\n        }\n        \n        \n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').hide()\n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').hide()\n        \n        if (!['Requirements Gathering', 'Scoping', 'Qualifying', 'Rejected'].includes(frm.doc.workflow_state) && frm.doc.opportunity_from == 'Prospect'){\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item[data-label=\"Customer\"]').show()\n        }\n        \n        if (frm.doc.workflow_state == \"Approved\"){\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').show()\n        }\n\n    },\n    validate: function(frm){\n        if (frm.doc.custom_request){\n            frm.set_df_property('custom_requirements', 'read_only', 0)\n        }\n        \n        \n        if (frm.doc.custom_requirements && frm.doc.workflow_state !== \"Scoping\" && frm.doc.workflow_state == \"Requirements Gathering\") {\n            frm.set_value('workflow_state', 'Scoping');\n            frm.refresh()\n        }\n        \n        /*if (frm.doc.custom_surveys.length > 0 && frm.doc.workflow_state == \"Surveying\") {\n            frm.set_value('workflow_state', 'Technical Qualification');\n            frm.refresh()\n        }*/\n    },\n    \n    create_issue(){\n\t\tfrappe.model.open_mapped_doc({\n\t\t\tmethod: \"ion_crm_sales.ion_support.support.triggers.create_issue\",\n\t\t\tfrm: cur_frm,\n\t\t\targs: {\n\t\t\t\tissue_from_dt: \"Opportunity\"\n\t\t\t}\n\t\t})\n\t},\n});\n\n\nfrappe.ui.form.on('Opportunity Item', {\n    calculate: function(frm, cdt, cdn){\n        var item = frappe.get_doc(cdt, cdn);\n        var item_code = item.item_code;\n        if (item_code && frm.doc.custom_warehouse) {\n            frappe.call({\n                method: \"frappe.client.get_value\",\n                args: {\n                    doctype: \"Bin\",\n                    filters: {\n                        \"item_code\": item_code,\n                        \"warehouse\": frm.doc.custom_warehouse\n                    },\n                    fieldname: [\"valuation_rate\", \"actual_qty\"]\n                },\n                callback: function(r) {\n                    if (r.message && r.message.valuation_rate) {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                    } else {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", \"Unavailable\")\n                        console.log(\"Valuation rate not found for item: \" + item_code + \" in warehouse: \" + frm.doc.custom_warehouse);\n                    }\n                }\n            });\n        }\n    },\n    item_code: function(frm, cdt, cdn) {\n        var item = frappe.get_doc(cdt, cdn);\n        var price_list = frm.doc.custom_price_list; // Get the selected price list from the Opportunity DocType\n        var item_code = item.item_code;\n\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Item Price',\n                filters: {\n                    item_code: item_code,\n                    price_list: price_list\n                },\n                fieldname: 'price_list_rate'\n            },\n            callback: function(response) {\n                if (response && response.message) {\n                    frappe.model.set_value(cdt, cdn, 'rate', response.message.price_list_rate);\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Opportunity Hotels",
  "enabled": 1,
  "modified": "2025-12-05 14:01:03.401015",
  "module": "Ion Crm Sales",
  "name": "Opportunity Hotels Workflow",
  "script": "frappe.ui.form.on('Opportunity Hotels', {\n    party_name: function(frm){\n        if (frm.doc.opportunity_from == \"Customer\"){\n\n            frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"Customer\",\n                        filters: {\n                            \"name\": frm.doc.party_name\n                        },\n                        fieldname: [\"custom_nationality\"]\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.custom_nationality) {\n                            frappe.model.set_value(\"Opportunity Hotels\", frm.doc.name, 'custom_nationality', r.message.custom_nationality);\n                        } \n                    }\n                });\n        }\n    },\n    \n    custom_warehouse: function(frm) {\n        frm.doc.items.forEach(function(item) {\n            // Check if the item_code is set in the current row\n            if (item.item_code) {\n                // Call a server-side method to fetch the valuation rate\n                frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"Bin\",\n                        filters: {\n                            \"item_code\": item.item_code,\n                            \"warehouse\": frm.doc.custom_warehouse\n                        },\n                        fieldname: [\"valuation_rate\", \"actual_qty\"]\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.valuation_rate) {\n                            // Set the valuation rate in the current row\n                            frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                        } else {\n                            frappe.model.set_value(item.doctype, item.name, \"custom_availability\", \"Unavailable\")\n                            frappe.show_alert(\"Valuation rate not found for \" + item.item_code, \"orange\");\n                        }\n                    }\n                });\n            }\n        });  \n    },\n    \n    opportunity_from: function(frm){\n        switch (frm.doc.opportunity_from){\n            case \"Customer\":\n                frm.doc.sales_stage = 'Opportunity';\n                frm.refresh_field('sales_stage')\n                break;\n            case \"Prospect\":\n                frm.doc.sales_stage = 'Prospecting';\n                frm.refresh_field('sales_stage')\n                break;\n        }\n    },\n    \n    refresh: function(frm) {\n        if (['Requirements Gathering', 'Scoping', 'Surveying', 'Approved'].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\".actions-btn-group\").hide()\n        } else {\n            frm.$wrapper.find(\".actions-btn-group\").show()\n        }\n        \n        if (frm.doc.opportunity_type === 'Sales') {\n            frm.set_value('opportunity_type', 'Dedicated');\n        }\n        \n        if (!frm.doc.custom_request){\n            frm.set_df_property('custom_requirements', 'read_only', 1)\n        }\n        \n        if ([\"Requirements Gathering\"].includes(frm.doc.workflow_state)) {\n            frm.$wrapper.find(\"[data-fieldname='custom_scope']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_scope']\").show();\n        }\n        \n        \n        if ([\"Requirements Gathering\", \"Scoping\"].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").show();\n        }\n        \n        if ([\"Requirements Gathering\", \"Scoping\", \"Qualifying\"].includes(frm.doc.workflow_state) || frm.doc.workflow_state == \"Rejected\") {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").show();\n        }\n        \n        \n        /*if (frm.doc.custom_surveys.length == 0){\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").hide()\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").show()\n        }*/\n        \n        \n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').hide()\n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').hide()\n        \n        if (!['Requirements Gathering', 'Scoping', 'Qualifying', 'Rejected'].includes(frm.doc.workflow_state) && frm.doc.opportunity_from == 'Prospect'){\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item[data-label=\"Customer\"]').show()\n        }\n        \n        if (frm.doc.workflow_state == \"Approved\"){\n            setTimeout(() => {\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').show()\n                \n            }, 300)\n        }\n        \n        if (frm.doc.workflow_state == \"Surveyed\"){\n            frm.$wrapper.find(\".actions-btn-group\").show()\n            setTimeout(() => {\n                frm.$wrapper.find(\".actions-btn-group .dropdown-item\").show()\n                frm.$wrapper.find(\".actions-btn-group .dropdown-item:has(.menu-item-label[data-label='Approve'])\")\n                \n            }, 300)\n            \n            \n            if (frm.doc.items.length > 0){\n                setTimeout(() => {\n                    frm.$wrapper.find('.actions-btn-group .dropdown-item:has(.menu-item-label[data-label=\"Approve\"])').show()\n                }, 300)\n            }\n        }\n\n    },\n    validate: function(frm){\n        if (frm.doc.custom_request){\n            frm.set_df_property('custom_requirements', 'read_only', 0)\n        }\n        \n        \n        if (frm.doc.custom_requirements && frm.doc.workflow_state !== \"Scoping\" && frm.doc.workflow_state == \"Requirements Gathering\") {\n            frm.set_value('workflow_state', 'Scoping');\n            frm.refresh()\n        }\n        \n        if (frm.doc.custom_scope_description && frm.doc.custom_deliverables && frm.doc.workflow_state == \"Scoping\"){\n            frm.set_value('workflow_state', 'Qualifying')\n            frm.refresh()\n        }\n    }\n});\n\n\n\nfrappe.ui.form.on('Opportunity Item', {\n    calculate: function(frm, cdt, cdn){\n        var item = frappe.get_doc(cdt, cdn);\n        var item_code = item.item_code;\n        if (item_code && frm.doc.custom_warehouse) {\n            frappe.call({\n                method: \"frappe.client.get_value\",\n                args: {\n                    doctype: \"Bin\",\n                    filters: {\n                        \"item_code\": item_code,\n                        \"warehouse\": frm.doc.custom_warehouse\n                    },\n                    fieldname: [\"valuation_rate\", \"actual_qty\"]\n                },\n                callback: function(r) {\n                    if (r.message && r.message.valuation_rate) {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                    } else {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", \"Unavailable\")\n                        console.log(\"Valuation rate not found for item: \" + item_code + \" in warehouse: \" + frm.doc.custom_warehouse);\n                    }\n                }\n            });\n        }\n    },\n    \n    item_code: function(frm, cdt, cdn) {\n        var item = frappe.get_doc(cdt, cdn);\n        var price_list = frm.doc.custom_price_list; // Get the selected price list from the Opportunity DocType\n        var item_code = item.item_code;\n\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Item Price',\n                filters: {\n                    item_code: item_code,\n                    price_list: price_list\n                },\n                fieldname: 'price_list_rate'\n            },\n            callback: function(response) {\n                if (response && response.message) {\n                    frappe.model.set_value(cdt, cdn, 'rate', response.message.price_list_rate);\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Opportunity SM",
  "enabled": 1,
  "modified": "2025-12-05 14:00:25.813880",
  "module": "Ion Crm Sales",
  "name": "Opportunity SM Workflow",
  "script": "frappe.ui.form.on('Opportunity SM', {\n    party_name: function(frm){\n        if (frm.doc.opportunity_from == \"Customer\"){\n\n            frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"Customer\",\n                        filters: {\n                            \"name\": frm.doc.party_name\n                        },\n                        fieldname: [\"custom_nationality\"]\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.custom_nationality) {\n                            frappe.model.set_value(\"Opportunity SM\", frm.doc.name, 'custom_nationality', r.message.custom_nationality);\n                        } \n                    }\n                });\n        }\n    },\n    \n    custom_warehouse: function(frm) {\n        frm.doc.items.forEach(function(item) {\n            // Check if the item_code is set in the current row\n            if (item.item_code) {\n                // Call a server-side method to fetch the valuation rate\n                frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"Bin\",\n                        filters: {\n                            \"item_code\": item.item_code,\n                            \"warehouse\": frm.doc.custom_warehouse\n                        },\n                        fieldname: [\"valuation_rate\", \"actual_qty\"]\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.valuation_rate) {\n                            // Set the valuation rate in the current row\n                            frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                        } else {\n                            frappe.model.set_value(item.doctype, item.name, \"custom_availability\", \"Unavailable\")\n                            frappe.show_alert(\"Valuation rate not found for \" + item.item_code, \"orange\");\n                        }\n                    }\n                });\n            }\n        });  \n    },\n    \n    opportunity_from: function(frm){\n        switch (frm.doc.opportunity_from){\n            case \"Customer\":\n                frm.doc.sales_stage = 'Opportunity';\n                frm.refresh_field('sales_stage')\n                break;\n            case \"Prospect\":\n                frm.doc.sales_stage = 'Prospecting';\n                frm.refresh_field('sales_stage')\n                break;\n        }\n    },\n    \n    refresh: function(frm) {\n        if (['Requirements Gathering', 'Scoping', 'Surveying', 'Approved'].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\".actions-btn-group\").hide()\n        } else {\n            frm.$wrapper.find(\".actions-btn-group\").show()\n        }\n        \n        if (frm.doc.opportunity_type === 'Sales') {\n            frm.set_value('opportunity_type', 'Dedicated');\n        }\n        \n        if (!frm.doc.custom_request){\n            frm.set_df_property('custom_requirements', 'read_only', 1)\n        }\n        \n        if ([\"Requirements Gathering\"].includes(frm.doc.workflow_state)) {\n            frm.$wrapper.find(\"[data-fieldname='custom_scope']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_scope']\").show();\n        }\n        \n        \n        if ([\"Requirements Gathering\", \"Scoping\"].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").show();\n        }\n        \n        if ([\"Requirements Gathering\", \"Scoping\", \"Qualifying\"].includes(frm.doc.workflow_state) || frm.doc.workflow_state == \"Rejected\") {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").show();\n        }\n        \n        \n        /*if (frm.doc.custom_surveys.length == 0){\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").hide()\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").show()\n        }*/\n        \n        \n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').hide()\n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').hide()\n        \n        if (!['Requirements Gathering', 'Scoping', 'Qualifying', 'Rejected'].includes(frm.doc.workflow_state) && frm.doc.opportunity_from == 'Prospect'){\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item[data-label=\"Customer\"]').show()\n        }\n        \n        if (frm.doc.workflow_state == \"Approved\"){\n            setTimeout(() => {\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').show()\n                \n            }, 300)\n        }\n        \n        if (frm.doc.workflow_state == \"Surveyed\"){\n            frm.$wrapper.find(\".actions-btn-group\").show()\n            setTimeout(() => {\n                frm.$wrapper.find(\".actions-btn-group .dropdown-item\").show()\n                //frm.$wrapper.find(\".actions-btn-group .dropdown-item:has(.menu-item-label[data-label='Approve'])\").hide()\n                \n            }, 300)\n            \n            \n                    frm.$wrapper.find('.actions-btn-group .dropdown-item:has(.menu-item-label[data-label=\"Approve\"])').show()\n            if (frm.doc.items.length > 0){\n                setTimeout(() => {\n                }, 300)\n            }\n        }\n\n    },\n    validate: function(frm){\n        if (frm.doc.custom_request){\n            frm.set_df_property('custom_requirements', 'read_only', 0)\n        }\n        \n        \n        if (frm.doc.custom_requirements && frm.doc.workflow_state !== \"Scoping\" && frm.doc.workflow_state == \"Requirements Gathering\") {\n            frm.set_value('workflow_state', 'Scoping');\n            frm.refresh()\n        }\n        \n        if (frm.doc.custom_scope_description && frm.doc.custom_deliverables && frm.doc.workflow_state == \"Scoping\"){\n            frm.set_value('workflow_state', 'Qualifying')\n            frm.refresh()\n        }\n    }\n});\n\n\nfrappe.ui.form.on('Opportunity Item', {\n    calculate: function(frm, cdt, cdn){\n        var item = frappe.get_doc(cdt, cdn);\n        var item_code = item.item_code;\n        if (item_code && frm.doc.custom_warehouse) {\n            frappe.call({\n                method: \"frappe.client.get_value\",\n                args: {\n                    doctype: \"Bin\",\n                    filters: {\n                        \"item_code\": item_code,\n                        \"warehouse\": frm.doc.custom_warehouse\n                    },\n                    fieldname: [\"valuation_rate\", \"actual_qty\"]\n                },\n                callback: function(r) {\n                    if (r.message && r.message.valuation_rate) {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                    } else {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", \"Unavailable\")\n                        console.log(\"Valuation rate not found for item: \" + item_code + \" in warehouse: \" + frm.doc.custom_warehouse);\n                    }\n                }\n            });\n        }\n    },\n    item_code: function(frm, cdt, cdn) {\n        var item = frappe.get_doc(cdt, cdn);\n        var price_list = frm.doc.custom_price_list; // Get the selected price list from the Opportunity DocType\n        var item_code = item.item_code;\n\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Item Price',\n                filters: {\n                    item_code: item_code,\n                    price_list: price_list\n                },\n                fieldname: 'price_list_rate'\n            },\n            callback: function(response) {\n                if (response && response.message) {\n                    frappe.model.set_value(cdt, cdn, 'rate', response.message.price_list_rate);\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Opportunity Tenders",
  "enabled": 1,
  "modified": "2025-12-05 14:00:43.802651",
  "module": "Ion Crm Sales",
  "name": "Opportunity Tenders Workflow",
  "script": "frappe.ui.form.on('Opportunity Tenders', {\n    party_name: function(frm){\n        if (frm.doc.opportunity_from == \"Customer\"){\n\n            frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"Customer\",\n                        filters: {\n                            \"name\": frm.doc.party_name\n                        },\n                        fieldname: [\"custom_nationality\"]\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.custom_nationality) {\n                            frappe.model.set_value(\"Opportunity Tenders\", frm.doc.name, 'custom_nationality', r.message.custom_nationality);\n                        } \n                    }\n                });\n        }\n    },\n    \n    custom_warehouse: function(frm) {\n        frm.doc.items.forEach(function(item) {\n            // Check if the item_code is set in the current row\n            if (item.item_code) {\n                // Call a server-side method to fetch the valuation rate\n                frappe.call({\n                    method: \"frappe.client.get_value\",\n                    args: {\n                        doctype: \"Bin\",\n                        filters: {\n                            \"item_code\": item.item_code,\n                            \"warehouse\": frm.doc.custom_warehouse\n                        },\n                        fieldname: [\"valuation_rate\", \"actual_qty\"]\n                    },\n                    callback: function(r) {\n                        if (r.message && r.message.valuation_rate) {\n                            // Set the valuation rate in the current row\n                            frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(item.doctype, item.name, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                        } else {\n                            frappe.model.set_value(item.doctype, item.name, \"custom_availability\", \"Unavailable\")\n                            frappe.show_alert(\"Valuation rate not found for \" + item.item_code, \"orange\");\n                        }\n                    }\n                });\n            }\n        });  \n    },\n    \n    opportunity_from: function(frm){\n        switch (frm.doc.opportunity_from){\n            case \"Customer\":\n                frm.doc.sales_stage = 'Opportunity';\n                frm.refresh_field('sales_stage')\n                break;\n            case \"Prospect\":\n                frm.doc.sales_stage = 'Prospecting';\n                frm.refresh_field('sales_stage')\n                break;\n        }\n    },\n    \n    refresh: function(frm) {\n        if (['Scoping', 'Surveying', 'Approved'].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\".actions-btn-group\").hide()\n        } else {\n            frm.$wrapper.find(\".actions-btn-group\").show()\n        }\n        \n        if (frm.doc.opportunity_type === 'Sales') {\n            frm.set_value('opportunity_type', 'Dedicated');\n        }\n        \n        \n        if ([\"Scoping\"].includes(frm.doc.workflow_state)){\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_qa']\").show();\n        }\n        \n        if ([\"Scoping\"].includes(frm.doc.workflow_state) || frm.doc.workflow_state == \"Rejected\") {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").hide();\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='custom_survey']\").show();\n        }\n        \n        \n        /*if (frm.doc.custom_surveys.length == 0){\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").hide()\n        } else {\n            frm.$wrapper.find(\"[data-fieldname='items_section']\").show()\n        }*/\n        \n        \n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').hide()\n        frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').hide()\n        \n        if (!['Scoping', 'Qualifying', 'Rejected'].includes(frm.doc.workflow_state) && frm.doc.opportunity_from == 'Prospect'){\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item[data-label=\"Customer\"]').show()\n        }\n        \n        if (frm.doc.workflow_state == \"Approved\"){\n            setTimeout(() => {\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"]').show()\n            frm.$wrapper.find('.inner-group-button[data-label=\"Create\"] .dropdown-item').show()\n                \n            }, 300)\n        }\n        \n        if (frm.doc.workflow_state == \"Surveyed\"){\n            frm.$wrapper.find(\".actions-btn-group\").show()\n            setTimeout(() => {\n                frm.$wrapper.find(\".actions-btn-group .dropdown-item\").show()\n                //frm.$wrapper.find(\".actions-btn-group .dropdown-item:has(.menu-item-label[data-label='Approve'])\").hide()\n                \n            }, 300)\n            \n            \n            if (frm.doc.items.length > 0){\n                setTimeout(() => {\n                    frm.$wrapper.find('.actions-btn-group .dropdown-item:has(.menu-item-label[data-label=\"Approve\"])').show()\n                }, 300)\n            }\n        }\n\n    },\n    validate: function(frm){\n        \n        if (frm.doc.custom_scope_description && frm.doc.custom_cxo_team.length > 0 && frm.doc.custom_cxo_team_leader && frm.doc.workflow_state == \"Scoping\"){\n            frm.set_value('workflow_state', 'Surveying')\n            frm.refresh()\n        }\n    }\n});\n\n\nfrappe.ui.form.on('Opportunity Item', {\n    calculate: function(frm, cdt, cdn){\n        var item = frappe.get_doc(cdt, cdn);\n        var item_code = item.item_code;\n        if (item_code && frm.doc.custom_warehouse) {\n            frappe.call({\n                method: \"frappe.client.get_value\",\n                args: {\n                    doctype: \"Bin\",\n                    filters: {\n                        \"item_code\": item_code,\n                        \"warehouse\": frm.doc.custom_warehouse\n                    },\n                    fieldname: [\"valuation_rate\", \"actual_qty\"]\n                },\n                callback: function(r) {\n                    if (r.message && r.message.valuation_rate) {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(r.message.valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(frm.doc.conversion_rate) * flt(item.custom_valuation_rate));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", r.message.actual_qty >= item.qty ? \"Available\" : \"Unavailable\")\n                    } else {\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_valuation_rate_company_currency\", flt(0));\n                        frappe.model.set_value(cdt, cdn, \"custom_availability\", \"Unavailable\")\n                        console.log(\"Valuation rate not found for item: \" + item_code + \" in warehouse: \" + frm.doc.custom_warehouse);\n                    }\n                }\n            });\n        }\n    },\n    item_code: function(frm, cdt, cdn) {\n        var item = frappe.get_doc(cdt, cdn);\n        var price_list = frm.doc.custom_price_list; // Get the selected price list from the Opportunity DocType\n        var item_code = item.item_code;\n\n        frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Item Price',\n                filters: {\n                    item_code: item_code,\n                    price_list: price_list\n                },\n                fieldname: 'price_list_rate'\n            },\n            callback: function(response) {\n                if (response && response.message) {\n                    frappe.model.set_value(cdt, cdn, 'rate', response.message.price_list_rate);\n                }\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Hotspot",
  "enabled": 0,
  "modified": "2025-08-15 17:48:30.672259",
  "module": "Ion Crm Sales",
  "name": "Hotspot Workflow",
  "script": "frappe.ui.form.on('Hotspot', {\n\trefresh(frm) {\n\t    /*if (frm.doc.workflow_state == 'Qualifying' && frm.doc.quote != ''){\n\t        if (frappe.db.exists('Quotation', {'name': frm.doc.quote})){\n\t            frm.doc.workflow_state = 'Quoted'\n\t        } else {\n\t            frm.doc.quote = ''\n\t        }\n\t    }*/\n\t    \n\t    frm.set_df_property('party_name', 'label', String(frm.doc.hotspot_for))\n\t    \n\t    if (['Requirements Gathering', 'Closed'].includes(frm.doc.workflow_state)){\n\t        frm.set_df_property('requirements', 'hidden', false)\n\t    } else {\n\t        frm.set_df_property('requirements', 'hidden', true)\n\t    }\n\t    \n\t    \n\t    if (frm.doc.workflow_state == 'Qualifying'){\n\t        frm.$wrapper.find(\".actions-btn-group\").hide()\n\t    } else {\n\t        frm.$wrapper.find(\".actions-btn-group\").show()\n\t    }\n\t\t\n\t},\n\t\n\thotspot_for(frm){\n\t    if (frm.doc.hotspot_for != \"\")\n\t        frm.set_df_property('party_name', 'label', String(frm.doc.hotspot_for))\n\t},\n\t\n\tvalidate(frm) {\n\t    if(frm.doc.workflow_state == \"Qualifying\" && frm.doc.request != ''){\n\t        switch (frm.doc.type){\n\t            case 'Reach':\n\t                // Do something\n\t                break;\n\t            case 'Received':\n\t                // Do received\n\t                break;\n\t            case 'Custom':\n\t                // Do custom\n\t                break;\n    \t        default:\n    \t            break;\n\t        }\n\t    }\n\t    \n\t    if (frm.doc.workflow_state == 'Qualifying' && frm.doc.request == ''){\n\t        frm.$wrapper.find(\".actions-btn-group\").hide()\n\t    } else {\n\t        frm.$wrapper.find(\".actions-btn-group\").show()\n\t    }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-12-05 13:07:02.916911",
  "module": "Ion Crm Sales",
  "name": "Sales Order Script",
  "script": "\nfrappe.ui.form.on('Sales Order', {\n    refresh(frm) {\n        if (frm.doc.docstatus === 0) {\n            frm.add_custom_button(__('Create Contract'), () => {\n                frappe.call({\n                    method: \"create_contract_for_so\",\n                    args: { sales_order: frm.doc.name },\n                    freeze: true,\n                    callback: (r) => {\n                        if (r.message) {\n                            frm.set_value('custom_contract', r.message);\n                            frappe.set_route('Form', 'Contract', r.message);\n                        }\n                    }\n                });\n            }, __('Actions'));\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Intercompany Stock Transfer",
  "enabled": 1,
  "modified": "2025-12-29 15:33:44.772098",
  "module": "ION Intercompany Transfer",
  "name": "Intercompany Stock Transfer Rate",
  "script": "\n// Freeze \"available_qty\" after submit by only calculating it in Draft (docstatus = 0).\n\nfunction is_draft(frm) {\n  return cint(frm.doc.docstatus) === 0;\n}\n\nfunction set_available_qty(frm, cdt, cdn) {\n  // Only compute when in Draft\n  if (!is_draft(frm)) return;\n\n  const row = locals[cdt][cdn];\n  const item = row.item_code;\n  const wh = frm.doc.issue_source_warehouse;\n\n  if (!item || !wh) {\n    frappe.model.set_value(cdt, cdn, 'available_qty', 0);\n    return;\n  }\n\n  // Read Bin (item-warehouse) balance; do not recompute after submit\n  frappe.call({\n    method: 'frappe.client.get_value',\n    args: {\n      doctype: 'Bin',\n      fieldname: ['actual_qty'],\n      filters: { item_code: item, warehouse: wh }\n    }\n  }).then(r => {\n    const qty = (r && r.message && r.message.actual_qty) ? r.message.actual_qty : 0;\n    frappe.model.set_value(cdt, cdn, 'available_qty', qty);\n  }).catch(() => {\n    frappe.model.set_value(cdt, cdn, 'available_qty', 0);\n  });\n}\n\n// Recalculate only in Draft when item changes\nfrappe.ui.form.on('Intercompany Stock Transfer Item', {\n  item_code: function(frm, cdt, cdn) {\n    set_available_qty(frm, cdt, cdn);\n  }\n});\n\n// Recalculate only in Draft when Issue Source Warehouse changes\nfrappe.ui.form.on('Intercompany Stock Transfer', {\n  issue_source_warehouse: function(frm) {\n    if (!is_draft(frm)) return;\n    (frm.doc.items || []).forEach(d => set_available_qty(frm, d.doctype, d.name));\n  },\n\n  // On refresh, compute only in Draft; leaves values untouched after submit/cancel\n  refresh: function(frm) {\n    if (!is_draft(frm)) return;\n    (frm.doc.items || []).forEach(d => set_available_qty(frm, d.doctype, d.name));\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2026-01-07 21:45:27.029819",
  "module": "Ion Crm Sales",
  "name": "Quotation Create Subscription",
  "script": "\nfrappe.ui.form.on('Quotation', {\n  refresh(frm) {\n    if (frm.doc.docstatus === 1) {\n      frm.add_custom_button(__('Create Subscription'), function () {\n        const origin = detect_originating_opportunity(frm.doc);\n        if (!origin) {\n          frappe.msgprint(__('No originating Opportunity found on this Quotation.'));\n          return;\n        }\n\n        // Prefill a *new, unsaved* Subscription and route user to it\n        const defaults = {\n          party_type: 'Customer',\n          party: frm.doc.party_name || frm.doc.customer || frm.doc.customer_name,\n          start_date: frappe.datetime.get_today(),\n\n          // Your custom Dynamic Link pair on Subscription:\n          custom_originating_doctype: origin.doctype,\n          custom_originating_document: origin.name\n        };\n\n        frappe.new_doc('Subscription', defaults).then(doc => {\n          frappe.set_route('Form', 'Subscription', doc.name);\n          // User will now add at least one Plan row, then Save/Submit.\n        });\n      }, __('Create'));\n    }\n  }\n});\n\n// Helper: detect the originating opportunity across your 4 fields\nfunction detect_originating_opportunity(doc) {\n  if (doc.opportunity)               return { doctype: 'Opportunity',               name: doc.opportunity };\n  if (doc.custom_opportunity_sm)     return { doctype: 'Opportunity SM',            name: doc.custom_opportunity_sm };\n  if (doc.custom_opportunity_hotels) return { doctype: 'Opportunity Hotels',        name: doc.custom_opportunity_hotels };\n  if (doc.custom_opportunity_tenders)return { doctype: 'Opportunity Tenders',       name: doc.custom_opportunity_tenders };\n  return null;\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Subscription",
  "enabled": 1,
  "modified": "2026-01-07 22:18:20.392278",
  "module": "Ion Crm Sales",
  "name": "Subscription Renew",
  "script": "\nfrappe.ui.form.on('Subscription', {\n  refresh(frm) {\n    if (!frm.doc.end_date) return;\n\n    // Days until expiry (positive = in future; <= 0 = expired)\n    const days_to_expiry = frappe.datetime.get_day_diff(\n      frm.doc.end_date,\n      frappe.datetime.get_today()\n    );\n    const RENEWAL_WINDOW_DAYS = 30; // adjust to your policy\n\n    if (days_to_expiry <= RENEWAL_WINDOW_DAYS) {\n      frm.add_custom_button(__('Renew (Prefill)'), function () {\n\n        // 1) Compute new start date: day after current end_date (fallback: today)\n        const new_start_date = frm.doc.end_date\n          ? frappe.datetime.add_days(frm.doc.end_date, 1)\n          : frappe.datetime.get_today();\n\n        // 2) Build defaults by copying important scalar fields safely\n        const FIELDS_TO_COPY = [\n          // Party / basics\n          'party_type', 'party', 'company', 'currency',\n\n          // Invoicing behavior\n          'days_until_due',\n          'generate_invoice_at_beginning_of_period',\n          'generate_new_invoices_past_due_date',\n\n          // Taxes / discounts\n          'sales_taxes_and_charges_template',\n          'apply_additional_discount', 'apply_discount_on',\n          'additional_discount_percentage', 'additional_discount_amount',\n\n          // Other useful flags / settings\n          'cancel_at_end_of_period',\n          'payment_gateway_account',\n\n          // Your origin (Dynamic Link pair)\n          'custom_originating_doctype', 'custom_originating_document'\n        ];\n\n        const defaults = { start_date: new_start_date };\n        const meta = frappe.get_meta('Subscription');\n        const metaFields = (meta?.fields || []).map(df => df.fieldname);\n\n        // Move value only if field exists on Subscription\n        FIELDS_TO_COPY.forEach(f => {\n          if (metaFields.includes(f) && frm.doc[f] != null) {\n            defaults[f] = frm.doc[f];\n          }\n        });\n\n        // 3) Create a prefilled, UNSAVED Subscription, then copy child rows in the callback\n        \nfrappe.new_doc('Subscription', defaults, (new_doc) => {\n  // Determine child doctype & parentfield for the plans table\n  const hasPlans = Array.isArray(frm.doc.plans) && frm.doc.plans.length > 0;\n\n  if (hasPlans) {\n    // Child DocType (usually \"Subscription Plan Detail\")\n    const child_doctype = frm.doc.plans[0].doctype || 'Subscription Plan Detail';\n\n    // Find the correct parentfield by reading Subscription's metadata (fallback to 'plans')\n    let parentfield = 'plans';\n    const tableField = frappe.get_meta('Subscription').fields.find(df =>\n      df.fieldtype === 'Table' &&\n      (df.options === child_doctype || df.fieldname === 'plans')\n    );\n    if (tableField) parentfield = tableField.fieldname;\n\n    // ðŸ”§ Clear the table to remove the default blank row\n    frappe.model.clear_table(new_doc, parentfield);\n\n    // Copy every plan row (all non-system fields)\n    frm.doc.plans.forEach(src_row => {\n      const child = frappe.model.add_child(new_doc, child_doctype, parentfield);\n      Object.keys(src_row).forEach(k => {\n        if (![\n          'name', 'owner', 'creation', 'modified', 'modified_by',\n          'parent', 'parenttype', 'parentfield', 'idx', 'docstatus', 'doctype'\n        ].includes(k)) {\n          child[k] = src_row[k];\n        }\n      });\n    });\n  }\n\n  // Route to the new, unsaved form after all prefill is complete\n  frappe.set_route('Form', 'Subscription', new_doc.name);\n\n  // Optional: toast\n  frappe.show_alert({\n    message: __('Review and Save the renewed Subscription.'),\n    indicator: 'blue'\n  });\n});\n\n      }, __('Actions'));\n    }\n\n    // Optional: Expired banner\n    if (days_to_expiry <= 0) {\n      frm.dashboard.set_headline(__('This subscription has expired.'));\n    }\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Issue",
  "enabled": 1,
  "modified": "2026-01-31 13:54:16.653749",
  "module": "ION Support",
  "name": "Issue Technicians",
  "script": "frappe.ui.form.on('Issue', {\n\tsetup(frm){\n\t    frm.set_query(\"custom_technicians\", function() {\n\t        return {\n\t            filters: {\n\t                custom_is_technician: 1\n\t            }\n\t        }\n\t    })\n\t}\n})",
  "view": "Form"
 }
]