[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-10 22:25:35.548653",
  "module": "Ion Crm Sales",
  "name": "Dedicated Quotation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Quotation",
  "script": "if (doc.get(\"opportunity\")):\n    opportunity_from = frappe.db.get_value(\"DocType\", {\"name\": doc.get(\"opportunity\")}, \"name\")\n    doc.custom_opportunity_from = opportunity_from",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-10 22:37:09.782323",
  "module": "Ion Crm Sales",
  "name": "Sales Order Opportunity",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Order",
  "script": "if doc.get(\"items\"):\n    from_quotation = doc.items[0].get(\"prevdoc_docname\")\n    if from_quotation:\n        source = frappe.db.get_value(\"Quotation\", from_quotation, [\"custom_opportunity_from\"], as_dict=True)\n        if source:\n            doc.custom_opportunity_from = source.custom_opportunity_from",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-10 22:37:41.691723",
  "module": "Ion Crm Sales",
  "name": "Sales Invoice Opportunity",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "if doc.get(\"items\"):\n    from_order = doc.items[0].get(\"prevdoc_docname\")\n    if from_order:\n        source = frappe.db.get_value(\"Sales Order\", from_order, [\"custom_opportunity_from\"], as_dict=True)\n        if source:\n            doc.custom_opportunity_from = source.custom_opportunity_from",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "create_contract_for_so",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-05 13:05:52.496362",
  "module": "Ion Crm Sales",
  "name": "Sales Order",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\n# Server Script (Type: API)\n# API Method: create_contract_for_so\n# NOTE: In Server Scripts, do not import modules and do not define functions.\n# Use top-level code, frappe.form_dict, frappe.get_doc, frappe.db.get_value, etc.\n\n# ---- Read args from client ----\nsales_order = frappe.form_dict.get('sales_order')\ntemplate_name = \"RMT Contract\"\nif not sales_order:\n    frappe.throw(\"Missing 'sales_order' argument.\")\n\n# ---- Load Sales Order ----\nso = frappe.get_doc(\"Sales Order\", sales_order)\n\n\n# ---- Prepare context for template rendering ----\n# Use fieldnames your template expects (ERPNext examples commonly use party_name/start_date/etc.)\ncustomer = so.get(\"customer\") or \"\"\ncustomer_name = frappe.db.get_value(\"Customer\", customer, \"customer_name\") or customer\n\npayload_doc = {\n    \"party_type\": \"Customer\",\n    # In Contract, 'party_name' is a Dynamic Link; most templates display the readable name:\n    \"party_name\": customer_name,\n    \"start_date\": frappe.utils.nowdate(),\n    # Provide optional values if your template uses them:\n    \"end_date\": None,\n    \"document_type\": \"Sales Order\",\n    \"document_name\": so.name,\n    # Add any extra variables your template needs (e.g., totals, items, company, etc.)\n}\n\n# ---- Render terms from Contract Template ----\nrendered_terms = None\ntry:\n    # Use ERPNext's official template renderer for Contract Templates.\n    # It returns {\"contract_template\": <Doc>, \"contract_terms\": \"<HTML/Text>\"}\n    result = frappe.call(\n        method=\"erpnext.crm.doctype.contract_template.contract_template.get_contract_template\",\n        template_name=template_name,\n        doc=payload_doc,\n    )\n    rendered_terms = (result or {}).get(\"contract_terms\")\nexcept Exception:\n    rendered_terms = None\n\n# Fallback: render locally if needed\nif not rendered_terms:\n    try:\n        tmpl = frappe.get_doc(\"Contract Template\", template_name)\n        if tmpl.get(\"contract_terms\"):\n            rendered_terms = frappe.render_template(tmpl.get(\"contract_terms\"), payload_doc)\n    except Exception:\n        rendered_terms = None\n\nif not rendered_terms:\n    frappe.throw(\"Could not render Contract Terms from template: \" + template_name)\n\n# ---- Create Contract ----\ncontract = frappe.new_doc(\"Contract\")\n\n# Party / linkage fields\ntry:\n    contract.party_type = \"Customer\"\nexcept Exception:\n    pass\ntry:\n    # For Dynamic Link 'party_name', you can store the *Customer ID* (customer) or display name.\n    # If your site expects the ID, use 'customer'; if display name, use 'customer_name'.\n    contract.party_name = customer  # change to 'customer_name' if your schema expects that\nexcept Exception:\n    pass\n\ncontract.start_date = payload_doc[\"start_date\"]\ncontract.status = \"Unsigned\"  # default lifecycle\ncontract.contract_template = template_name\ncontract.contract_terms = rendered_terms\n\n# Optionally link back to the source SO for traceability\ntry:\n    contract.document_type = \"Sales Order\"\n    contract.document_name = so.name\nexcept Exception:\n    pass\n\ncontract.insert(ignore_permissions=True)\n\n# ---- Link Contract back onto the Sales Order ----\nlink_field = \"contract\"  # change if your Sales Order's link field uses a different fieldname\nif link_field in so.as_dict():\n    so.set(link_field, contract.name)\n    so.save(ignore_permissions=True)\n\n# ---- Respond with the Contract name so the client can open it ----\nfrappe.response[\"message\"] = contract.name",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-05 13:11:09.582302",
  "module": "Ion Crm Sales",
  "name": "Block Sales Order Submission",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Order",
  "script": "if not doc.custom_contract:\n    frappe.throw(_(\"You must link a Contract before submitting this Sales Order.\"))\n\ncontract = frappe.get_doc(\"Contract\", doc.custom_contract)\nif contract.status != \"Active\":\n    frappe.throw(_(\"The linked Contract must be signed before submitting the Sales Order.\"))\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-29 15:09:20.520853",
  "module": "ION Intercompany Transfer",
  "name": "Intercompany Transfer",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Intercompany Stock Transfer",
  "script": "\n# Server Script: after_submit on Intercompany Stock Transfer\n# Source the unit rate from Material Issue (SLE) and reuse it for Receipt and JEs.\n# Safe for Server Script: no imports, no getattr, no augmented ops.\n\n# -----------------------------\n# CONFIG\n# -----------------------------\nSENDER_AR_BASE = \"1010 - Intercompany Receivable\"    # change if numbering differs\nRECEIVER_AP_BASE = \"2010 - Intercompany Payable\"     # change if numbering differs\n# If both sides resolve to 0, allow stock to move (skip JEs) and show a message\nALLOW_ZERO_VALUATION = 1\n\n# -----------------------------\n# Helpers\n# -----------------------------\ndef exists_se(voucher_no):\n    if not voucher_no:\n        return False\n    if not frappe.db.exists(\"Stock Entry\", voucher_no):\n        return False\n    try:\n        se = frappe.get_doc(\"Stock Entry\", voucher_no)\n        return se.docstatus == 1\n    except Exception:\n        return False\n\ndef item_has_batch_no(item_code):\n    return 1 if (frappe.db.get_value(\"Item\", item_code, \"has_batch_no\") or 0) else 0\n\ndef is_batch_for_item(batch_id, item_code):\n    return True if frappe.db.get_value(\"Batch\", {\"name\": batch_id, \"item\": item_code}, \"name\") else False\n\ndef is_batch_expired_on(batch_id, ymd_date):\n    exp = frappe.db.get_value(\"Batch\", batch_id, \"expiry_date\")\n    if not exp:\n        return False\n    try:\n        return True if exp <= ymd_date else False\n    except Exception:\n        return False\n\ndef get_issue_unit_rate_from_sle(issue_voucher_no, voucher_detail_no):\n    \"\"\"Return the Issue unit cost for a specific Stock Entry row, from SLE.\n       unit_rate = abs(sum(stock_value_difference)) / abs(sum(actual_qty)) for SLE rows\n       matching the voucher detail line (outgoing -> actual_qty < 0).\"\"\"\n    rows = frappe.get_all(\n        \"Stock Ledger Entry\",\n        filters={\n            \"voucher_type\": \"Stock Entry\",\n            \"voucher_no\": issue_voucher_no,\n            \"voucher_detail_no\": voucher_detail_no,\n            \"is_cancelled\": 0\n        },\n        fields=[\"actual_qty\", \"stock_value_difference\"]\n    )\n    total_qty = 0.0\n    total_value = 0.0\n    for r in rows:\n        try:\n            aq = float(r.get(\"actual_qty\") or 0.0)\n        except Exception:\n            aq = 0.0\n        try:\n            svd = float(r.get(\"stock_value_difference\") or 0.0)\n        except Exception:\n            svd = 0.0\n        total_qty = total_qty + abs(aq)\n        total_value = total_value + abs(svd)\n    if total_qty > 0:\n        return total_value / total_qty\n    return 0.0\n\ndef sum_amount(items, idx_to_rate):\n    total = 0.0\n    for i, d in enumerate(items):\n        try:\n            qty = float(d.get(\"qty\") or 0.0)\n        except Exception:\n            qty = 0.0\n        rate = idx_to_rate.get(i, 0.0)\n        total = total + (qty * rate)\n    return total\n\n# -----------------------------\n# 0) Basic validations + inter-company enforcement\n# -----------------------------\nitems = doc.get(\"items\")\nif not items:\n    frappe.throw(\"No items found on this Intercompany Stock Transfer.\")\n\nfor d in items:\n    item_code = d.get(\"item_code\")\n    if not item_code:\n        frappe.throw(\"Item code is required on each row.\")\n    try:\n        qty = float(d.get(\"qty\") or 0)\n    except Exception:\n        qty = 0.0\n    if qty <= 0:\n        frappe.throw(f\"Quantity must be greater than zero for item {item_code}.\")\n\nissue_company = doc.get(\"issue_company\")\nreceipt_company = doc.get(\"receipt_company\")\nif not issue_company or not receipt_company:\n    frappe.throw(\"Both Issue Company and Receipt Company must be set.\")\nif issue_company == receipt_company:\n    frappe.throw(\"Inter-company only: Issue Company and Receipt Company must be different.\")\n\nposting_date = doc.get(\"posting_date\") or frappe.utils.nowdate()\nposting_time = doc.get(\"posting_time\") or frappe.utils.nowtime()\nset_posting_time = 1 if doc.get(\"set_posting_time\") else 0\n\n# v15 batch validations: prevent expired batch usage and wrong item-batch combos\nfor d in items:\n    item_code = d.get(\"item_code\")\n    if item_has_batch_no(item_code):\n        b = d.get(\"batch_no\")\n        if not b:\n            frappe.throw(f\"Item {item_code} requires a Batch No (batch_no).\")\n        if not is_batch_for_item(b, item_code):\n            frappe.throw(f\"Batch {b} does not belong to Item {item_code}.\")\n        if is_batch_expired_on(b, posting_date):\n            frappe.throw(f\"Batch {b} is expired on posting date {posting_date}.\")\n\n# -----------------------------\n# 0.a) Intercompany AR/AP accounts (numbered) must exist\n# -----------------------------\nissue_abbr = frappe.db.get_value(\"Company\", issue_company, \"abbr\")\nreceipt_abbr = frappe.db.get_value(\"Company\", receipt_company, \"abbr\")\nif not issue_abbr or not receipt_abbr:\n    frappe.throw(\"Company abbreviations are required (check Company records).\")\n\nsender_ar_override = doc.get(\"sender_ar_account_name\")\nreceiver_ap_override = doc.get(\"receiver_ap_account_name\")\n\nif sender_ar_override:\n    ic_ar_name = sender_ar_override\nelse:\n    ic_ar_name = frappe.db.get_value(\n        \"Account\",\n        {\"company\": issue_company, \"name\": SENDER_AR_BASE + \" - \" + issue_abbr},\n        \"name\"\n    )\n\nif receiver_ap_override:\n    ic_ap_name = receiver_ap_override\nelse:\n    ic_ap_name = frappe.db.get_value(\n        \"Account\",\n        {\"company\": receipt_company, \"name\": RECEIVER_AP_BASE + \" - \" + receipt_abbr},\n        \"name\"\n    )\n\nif not ic_ar_name:\n    frappe.throw(\n        f\"Missing Intercompany Receivable in {issue_company}. \"\n        f\"Create: '{SENDER_AR_BASE} - {issue_abbr}' under Current Assets (Is Group: No).\"\n    )\nif not ic_ap_name:\n    frappe.throw(\n        f\"Missing Intercompany Payable in {receipt_company}. \"\n        f\"Create: '{RECEIVER_AP_BASE} - {receipt_abbr}' under Current Liabilities (Is Group: No).\"\n    )\n\n# -----------------------------\n# 1) Create Material Issue (sender)\n# -----------------------------\nissue_name = None\nissue_source_wh = doc.get(\"issue_source_warehouse\")\nif not issue_source_wh:\n    frappe.throw(\"Issue Source Warehouse must be set.\")\nwh_company_issue = frappe.db.get_value(\"Warehouse\", issue_source_wh, \"company\")\nif wh_company_issue != issue_company:\n    frappe.throw(f\"Source Warehouse {issue_source_wh} belongs to {wh_company_issue}, not {issue_company}.\")\n\nse_issue = frappe.get_doc({\n    \"doctype\": \"Stock Entry\",\n    \"stock_entry_type\": \"Material Issue\",\n    \"company\": issue_company,\n    \"posting_date\": posting_date,\n    \"posting_time\": posting_time,\n    \"set_posting_time\": set_posting_time,\n    \"remarks\": (doc.get(\"remarks\") or \"\") + f\"\\nSource: {doc.doctype} {doc.name}\",\n})\n\n# Build Issue lines in the same order as doc.items so we can map indices later\nfor d in items:\n    item_code = d.get(\"item_code\")\n    uom = d.get(\"uom\") or frappe.db.get_value(\"Item\", item_code, \"stock_uom\")\n    conversion_factor = d.get(\"conversion_factor\") or 1\n    description = d.get(\"description\") or (frappe.db.get_value(\"Item\", item_code, \"description\") or item_code)\n\n    row = {\n        \"item_code\": item_code,\n        \"s_warehouse\": issue_source_wh,\n        \"qty\": d.get(\"qty\"),\n        \"uom\": uom,\n        \"conversion_factor\": conversion_factor,\n        # DO NOT set basic_rate here; Issue valuation is computed by ERPNext at submit\n        \"description\": description,\n    }\n    serial_no = d.get(\"serial_no\")\n    batch_no = d.get(\"batch_no\")\n    if serial_no: row[\"serial_no\"] = serial_no\n    if batch_no: row[\"batch_no\"] = batch_no\n    se_issue.append(\"items\", row)\n\nse_issue.flags.ignore_permissions = True\nse_issue.insert()\nse_issue.submit()\nissue_name = se_issue.name\n\n# -----------------------------\n# 1.a) Build a per-row unit rate map from SLE (index -> unit_rate)\n# -----------------------------\n# We map by index: nth doc.items -> nth se_issue.items (order is preserved on append/submit).\nidx_to_rate = {}\nfor i, issue_row in enumerate(se_issue.items):\n    unit_rate = get_issue_unit_rate_from_sle(issue_name, issue_row.name)\n    idx_to_rate[i] = unit_rate\n\n# -----------------------------\n# 2) Create Material Receipt (receiver), using Issue unit rate per row\n# -----------------------------\nreceipt_name = None\nreceipt_target_wh = doc.get(\"receipt_target_warehouse\")\nif not receipt_target_wh:\n    try:\n        if exists_se(issue_name):\n            se_issue = frappe.get_doc(\"Stock Entry\", issue_name)\n            if se_issue.docstatus == 1: se_issue.cancel()\n    except Exception as cancel_err:\n        frappe.log_error(title=\"Intercompany Transfer: rollback failed\",\n                         message=f\"Could not cancel Material Issue {issue_name}: {cancel_err}\")\n    frappe.throw(\"Receipt Target Warehouse must be set.\")\n\nwh_company_receipt = frappe.db.get_value(\"Warehouse\", receipt_target_wh, \"company\")\nif wh_company_receipt != receipt_company:\n    try:\n        if exists_se(issue_name):\n            se_issue = frappe.get_doc(\"Stock Entry\", issue_name)\n            if se_issue.docstatus == 1: se_issue.cancel()\n    except Exception as cancel_err:\n        frappe.log_error(title=\"Intercompany Transfer: rollback failed\",\n                         message=f\"Could not cancel Material Issue {issue_name}: {cancel_err}\")\n    frappe.throw(f\"Target Warehouse {receipt_target_wh} belongs to {wh_company_receipt}, not {receipt_company}.\")\n\nse_receipt = frappe.get_doc({\n    \"doctype\": \"Stock Entry\",\n    \"stock_entry_type\": \"Material Receipt\",\n    \"company\": receipt_company,\n    \"posting_date\": posting_date,\n    \"posting_time\": posting_time,\n    \"set_posting_time\": set_posting_time,\n    \"remarks\": (doc.get(\"remarks\") or \"\") + f\"\\nSource: {doc.doctype} {doc.name}\",\n})\n\nfor i, d in enumerate(items):\n    item_code = d.get(\"item_code\")\n    uom = d.get(\"uom\") or frappe.db.get_value(\"Item\", item_code, \"stock_uom\")\n    conversion_factor = d.get(\"conversion_factor\") or 1\n    description = d.get(\"description\") or (frappe.db.get_value(\"Item\", item_code, \"description\") or item_code)\n\n    incoming_rate = idx_to_rate.get(i, 0.0)  # the unit cost ERPNext posted on Issue\n\n    row = {\n        \"item_code\": item_code,\n        \"t_warehouse\": receipt_target_wh,\n        \"qty\": d.get(\"qty\"),\n        \"uom\": uom,\n        \"conversion_factor\": conversion_factor,\n        \"basic_rate\": incoming_rate,\n        \"description\": description,\n    }\n    serial_no = d.get(\"serial_no\")\n    batch_no = d.get(\"batch_no\")\n    if serial_no: row[\"serial_no\"] = serial_no\n    if batch_no: row[\"batch_no\"] = batch_no\n    se_receipt.append(\"items\", row)\n\nse_receipt.flags.ignore_permissions = True\nse_receipt.insert()\nse_receipt.submit()\nreceipt_name = se_receipt.name\n\n# Ensure vouchers exist and are submitted\nif not exists_se(issue_name):\n    frappe.throw(f\"Source Stock Entry not found or not submitted: {issue_name}.\")\nif not exists_se(receipt_name):\n    try:\n        if exists_se(issue_name):\n            se_i = frappe.get_doc(\"Stock Entry\", issue_name)\n            if se_i.docstatus == 1: se_i.cancel()\n    except Exception as cancel_err:\n        frappe.log_error(title=\"Intercompany: missing Receipt SE; rollback Issue failed\", message=str(cancel_err))\n    frappe.throw(f\"Target Stock Entry not found or not submitted: {receipt_name}.\")\n\n# -----------------------------\n# 3) Determine JE amounts from Issue unit rates (symmetry)\n# -----------------------------\nsender_amount = sum_amount(items, idx_to_rate)\nreceiver_amount = sender_amount\n\n# Resolve \"Stock Adjustment\" accounts for both companies\nsender_expense_account = (\n    frappe.db.get_value(\"Account\", {\"company\": issue_company, \"account_name\": \"Stock Adjustment\"}, \"name\")\n    or frappe.db.get_value(\"Account\", {\"company\": issue_company, \"name\": f\"Stock Adjustment - {issue_abbr}\"}, \"name\")\n)\nif not sender_expense_account:\n    frappe.throw(f\"Could not resolve a Stock Adjustment account for {issue_company}.\")\n\nreceiver_expense_account = (\n    frappe.db.get_value(\"Account\", {\"company\": receipt_company, \"account_name\": \"Stock Adjustment\"}, \"name\")\n    or frappe.db.get_value(\"Account\", {\"company\": receipt_company, \"name\": f\"Stock Adjustment - {receipt_abbr}\"}, \"name\")\n)\nif not receiver_expense_account:\n    frappe.throw(f\"Could not resolve a Stock Adjustment account for {receipt_company}.\")\n\n# Zero-valuation branch\nif sender_amount == 0.0 and receiver_amount == 0.0:\n    if ALLOW_ZERO_VALUATION:\n        try:\n            frappe.db.set_value(doc.doctype, doc.name, \"material_issue\", issue_name)\n            frappe.db.set_value(doc.doctype, doc.name, \"material_receipt\", receipt_name)\n        except Exception as link_err:\n            frappe.log_error(title=\"Interco: link SE (zero valuation) failed\", message=str(link_err))\n        frappe.msgprint(\n            msg=f\"Intercompany transfer {doc.name} completed.\\n\"\n                f\"JEs were skipped because Issue valuation resolved to zero.\\n\"\n                f\"Provide non-zero cost upstream if you want JEs to post.\",\n            title=\"Intercompany Transfer (Zero Valuation)\",\n            indicator=\"blue\"\n        )\n        raise SystemExit\n    else:\n        try:\n            if exists_se(issue_name):\n                se_i = frappe.get_doc(\"Stock Entry\", issue_name)\n                if se_i.docstatus == 1: se_i.cancel()\n            if exists_se(receipt_name):\n                se_r = frappe.get_doc(\"Stock Entry\", receipt_name)\n                if se_r.docstatus == 1: se_r.cancel()\n        except Exception as cancel_err:\n            frappe.log_error(title=\"Intercompany JE: rollback failed (zero valuation)\", message=str(cancel_err))\n        frappe.throw(f\"Issue {issue_name} and Receipt {receipt_name} resolved to zero valuation; JEs not created.\")\n\n# -----------------------------\n# 4) Create JEs (symmetric)\n# -----------------------------\nsender_je_name = None\nreceiver_je_name = None\ntry:\n    # Sender JE: Dr Intercompany Receivable, Cr Stock Adjustment\n    je_sender = frappe.get_doc({\n        \"doctype\": \"Journal Entry\",\n        \"company\": issue_company,\n        \"posting_date\": posting_date,\n        \"user_remark\": f\"Intercompany transfer {doc.doctype} {doc.name} | Issue SE: {issue_name}\",\n        \"set_posting_time\": set_posting_time,\n        \"accounts\": [\n            {\"account\": ic_ar_name, \"debit_in_account_currency\": sender_amount, \"credit_in_account_currency\": 0},\n            {\"account\": sender_expense_account, \"debit_in_account_currency\": 0, \"credit_in_account_currency\": sender_amount}\n        ]\n    })\n    je_sender.flags.ignore_permissions = True\n    je_sender.insert()\n    je_sender.submit()\n    sender_je_name = je_sender.name\n\n    # Receiver JE: Dr Stock Adjustment, Cr Intercompany Payable\n    je_receiver = frappe.get_doc({\n        \"doctype\": \"Journal Entry\",\n        \"company\": receipt_company,\n        \"posting_date\": posting_date,\n        \"user_remark\": f\"Intercompany transfer {doc.doctype} {doc.name} | Receipt SE: {receipt_name}\",\n        \"set_posting_time\": set_posting_time,\n        \"accounts\": [\n            {\"account\": receiver_expense_account, \"debit_in_account_currency\": receiver_amount, \"credit_in_account_currency\": 0},\n            {\"account\": ic_ap_name, \"debit_in_account_currency\": 0, \"credit_in_account_currency\": receiver_amount}\n        ]\n    })\n    je_receiver.flags.ignore_permissions = True\n    je_receiver.insert()\n    je_receiver.submit()\n    receiver_je_name = je_receiver.name\n\nexcept Exception as je_err:\n    # Cancel JEs if any were created\n    try:\n        if sender_je_name:\n            je_s = frappe.get_doc(\"Journal Entry\", sender_je_name)\n            if je_s.docstatus == 1: je_s.cancel()\n    except Exception:\n        pass\n    try:\n        if receiver_je_name:\n            je_r = frappe.get_doc(\"Journal Entry\", receiver_je_name)\n            if je_r.docstatus == 1: je_r.cancel()\n    except Exception:\n        pass\n\n    # Cancel SEs to keep atomicity (block submission)\n    try:\n        if exists_se(issue_name):\n            se_i = frappe.get_doc(\"Stock Entry\", issue_name)\n            if se_i.docstatus == 1: se_i.cancel()\n        if exists_se(receipt_name):\n            se_r = frappe.get_doc(\"Stock Entry\", receipt_name)\n            if se_r.docstatus == 1: se_r.cancel()\n    except Exception as cancel_err:\n        frappe.log_error(title=\"Intercompany JE: rollback failed\",\n                         message=f\"Could not cancel SEs after JE failure: {cancel_err}\")\n    raise je_err\n\n# -----------------------------\n# 5) Link SEs & JEs back to source (after success)\n# -----------------------------\ntry:\n    frappe.db.set_value(doc.doctype, doc.name, \"material_issue\", issue_name)\n    frappe.db.set_value(doc.doctype, doc.name, \"material_receipt\", receipt_name)\nexcept Exception as link_err:\n    frappe.log_error(title=\"Interco: link SE failed\", message=str(link_err))\n\ntry: frappe.db.set_value(doc.doctype, doc.name, \"sender_journal_entry\", sender_je_name)\nexcept Exception: pass\ntry: frappe.db.set_value(doc.doctype, doc.name, \"receiver_journal_entry\", receiver_je_name)\nexcept Exception: pass",
  "script_type": "DocType Event"
 }
]