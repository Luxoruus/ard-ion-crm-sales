[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-10 22:25:35.548653",
  "module": "Ion Crm Sales",
  "name": "Dedicated Quotation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Quotation",
  "script": "if (doc.get(\"opportunity\")):\n    opportunity_from = frappe.db.get_value(\"DocType\", {\"name\": doc.get(\"opportunity\")}, \"name\")\n    doc.custom_opportunity_from = opportunity_from",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-10 22:37:09.782323",
  "module": "Ion Crm Sales",
  "name": "Sales Order Opportunity",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Order",
  "script": "if doc.get(\"items\"):\n    from_quotation = doc.items[0].get(\"prevdoc_docname\")\n    if from_quotation:\n        source = frappe.db.get_value(\"Quotation\", from_quotation, [\"custom_opportunity_from\"], as_dict=True)\n        if source:\n            doc.custom_opportunity_from = source.custom_opportunity_from",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-10 22:37:41.691723",
  "module": "Ion Crm Sales",
  "name": "Sales Invoice Opportunity",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "if doc.get(\"items\"):\n    from_order = doc.items[0].get(\"prevdoc_docname\")\n    if from_order:\n        source = frappe.db.get_value(\"Sales Order\", from_order, [\"custom_opportunity_from\"], as_dict=True)\n        if source:\n            doc.custom_opportunity_from = source.custom_opportunity_from",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "create_contract_for_so",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-05 13:05:52.496362",
  "module": "Ion Crm Sales",
  "name": "Sales Order",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\n# Server Script (Type: API)\n# API Method: create_contract_for_so\n# NOTE: In Server Scripts, do not import modules and do not define functions.\n# Use top-level code, frappe.form_dict, frappe.get_doc, frappe.db.get_value, etc.\n\n# ---- Read args from client ----\nsales_order = frappe.form_dict.get('sales_order')\ntemplate_name = \"RMT Contract\"\nif not sales_order:\n    frappe.throw(\"Missing 'sales_order' argument.\")\n\n# ---- Load Sales Order ----\nso = frappe.get_doc(\"Sales Order\", sales_order)\n\n\n# ---- Prepare context for template rendering ----\n# Use fieldnames your template expects (ERPNext examples commonly use party_name/start_date/etc.)\ncustomer = so.get(\"customer\") or \"\"\ncustomer_name = frappe.db.get_value(\"Customer\", customer, \"customer_name\") or customer\n\npayload_doc = {\n    \"party_type\": \"Customer\",\n    # In Contract, 'party_name' is a Dynamic Link; most templates display the readable name:\n    \"party_name\": customer_name,\n    \"start_date\": frappe.utils.nowdate(),\n    # Provide optional values if your template uses them:\n    \"end_date\": None,\n    \"document_type\": \"Sales Order\",\n    \"document_name\": so.name,\n    # Add any extra variables your template needs (e.g., totals, items, company, etc.)\n}\n\n# ---- Render terms from Contract Template ----\nrendered_terms = None\ntry:\n    # Use ERPNext's official template renderer for Contract Templates.\n    # It returns {\"contract_template\": <Doc>, \"contract_terms\": \"<HTML/Text>\"}\n    result = frappe.call(\n        method=\"erpnext.crm.doctype.contract_template.contract_template.get_contract_template\",\n        template_name=template_name,\n        doc=payload_doc,\n    )\n    rendered_terms = (result or {}).get(\"contract_terms\")\nexcept Exception:\n    rendered_terms = None\n\n# Fallback: render locally if needed\nif not rendered_terms:\n    try:\n        tmpl = frappe.get_doc(\"Contract Template\", template_name)\n        if tmpl.get(\"contract_terms\"):\n            rendered_terms = frappe.render_template(tmpl.get(\"contract_terms\"), payload_doc)\n    except Exception:\n        rendered_terms = None\n\nif not rendered_terms:\n    frappe.throw(\"Could not render Contract Terms from template: \" + template_name)\n\n# ---- Create Contract ----\ncontract = frappe.new_doc(\"Contract\")\n\n# Party / linkage fields\ntry:\n    contract.party_type = \"Customer\"\nexcept Exception:\n    pass\ntry:\n    # For Dynamic Link 'party_name', you can store the *Customer ID* (customer) or display name.\n    # If your site expects the ID, use 'customer'; if display name, use 'customer_name'.\n    contract.party_name = customer  # change to 'customer_name' if your schema expects that\nexcept Exception:\n    pass\n\ncontract.start_date = payload_doc[\"start_date\"]\ncontract.status = \"Unsigned\"  # default lifecycle\ncontract.contract_template = template_name\ncontract.contract_terms = rendered_terms\n\n# Optionally link back to the source SO for traceability\ntry:\n    contract.document_type = \"Sales Order\"\n    contract.document_name = so.name\nexcept Exception:\n    pass\n\ncontract.insert(ignore_permissions=True)\n\n# ---- Link Contract back onto the Sales Order ----\nlink_field = \"contract\"  # change if your Sales Order's link field uses a different fieldname\nif link_field in so.as_dict():\n    so.set(link_field, contract.name)\n    so.save(ignore_permissions=True)\n\n# ---- Respond with the Contract name so the client can open it ----\nfrappe.response[\"message\"] = contract.name",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-05 13:11:09.582302",
  "module": "Ion Crm Sales",
  "name": "Block Sales Order Submission",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Order",
  "script": "if not doc.custom_contract:\n    frappe.throw(_(\"You must link a Contract before submitting this Sales Order.\"))\n\ncontract = frappe.get_doc(\"Contract\", doc.custom_contract)\nif contract.status != \"Active\":\n    frappe.throw(_(\"The linked Contract must be signed before submitting the Sales Order.\"))\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": "* 22 * * *",
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "Hourly",
  "modified": "2026-01-08 14:32:50.174722",
  "module": "Ion Crm Sales",
  "name": "Notify Expiring Subscription",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\nfrom ion_crm_sales.notifications import send_subscription_expiry_alerts\nsend_subscription_expiry_alerts(window_days=15)\n",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-25 09:28:31.962088",
  "module": "Ion Crm Sales",
  "name": "Testing the naming series",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "cur_name = doc.name\ncompany = frappe.get_doc(\"Company\", frappe.db.get_value(\"Employee\", {'user_id': frappe.session.user}, \"company\"))\nnew_name = str(company.abbr) + '-' + str(cur_name)\n\ndoc.db_set(\"name\", new_name, commit=True)",
  "script_type": "DocType Event"
 }
]